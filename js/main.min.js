$(function(){var a,e,b=document.body.offsetWidth,c=document.body.offsetHeight,d=document.querySelector("#audio"),f={imgTotal:11,curImgCount:0,curQuestion:0,curBg:0,bgPos:[{x:95,y:35,width:570,height:1010},{x:84,y:42,width:584,height:1025},{x:95,y:75,width:570,height:965},{x:115,y:87,width:510,height:1e3}],bgTxtPos:{name:{x:200,y:209,width:366,height:54},day:{x:406,y:953,width:102,height:34}},url:"",mySwiper:null,isPlaying:!1,data:{name:"mt",day:"1,222",department:"电商事业部",headimgurl:"http://cloud.huaruntong.cn/web/activity/yld0420/images/logo.jpg?v=04"},imgIntervalId:null,generating:!1,init:function(){var e,a=this;this.initEvent(),d.volume=.2,$("#pic-cnt-generate").css("height",c+"px"),e=document.getElementById("result-canvas"),e.width=b,e.height=c,this.getAuth(),$(document).on("WeixinJSBridgeReady",function(){a.paused&&!a.isPlaying&&(d.play(),d.volume=.2,a.isPlaying=!0)})},imgLoading:function(){var c,a=this,b=0;$("img").each(function(){this.complete&&b++}),a.curImgCount=b,c=100*a.curImgCount/a.imgTotal,a.curImgCount>=a.imgTotal?(clearTimeout(a.imgIntervalId),$(".loading-text").html("100%"),setTimeout(function(){$("#loading").addClass("hide"),$("#swiper-container").removeClass("none")},100)):($(".loading-text").html(c.toFixed(0)+"%"),a.imgIntervalId=setTimeout(function(){a.imgLoading()},500))},initEvent:function(){var a=this;document.getElementById("face"),window.URL=window.URL||window.webkitURL,a.imgLoading(),$(document).on("touchend",function(){$("#people").removeClass("mask")}),$(document).on("touchmove",function(a){a.preventDefault()}),$(".upload").on("change",function(){var c,b=this.files[0];window.URL?a.faceLoaded(window.URL.createObjectURL(b)):(c=new FileReader,c.readAsDataURL(b),c.onload=function(){var b=c.result;a.faceLoaded(b)})}),$(".startBtn").on("click",function(){a.initSwiper(),a.initSvg(),a.mySwiper.slideNext(),a.initQuestion()}),$(".question-next").on("click",function(){a.initQuestion()}),$(".user-next").on("click",function(){var b=$(".p3");b.find(".uploadBtn:first").removeClass("none"),b.find(".uploaded").addClass("none"),$(".tip").addClass("none"),a.mySwiper.slideNext(),a.initFace()}),$("#generateBtn").on("click",function(){a.generating||(a.generating=!0,document.querySelector("#generateBtn").innerHTML="生成中……",a.generateImg())}),document.getElementById("music").addEventListener("click",function(){var b=$(this);b.toggleClass("play"),b.hasClass("play")?(d.play(),a.isPlaying=!0):(d.pause(),a.isPlaying=!1)})},faceLoaded:function(a){var b=$(".p3");b.find(".uploadBtn:first").addClass("none"),b.find(".uploaded").removeClass("none"),$(".tip").removeClass("none"),this.initZoom(a)},generateImg:function(){var e,g,h,i,j,k,m,n,o,p,q,r,s,t,u,d=this,f=$(".backFace").find("canvas")[0],l=$("#backupCanvas")[0];l.width=b,l.height=c,m=l.getContext("2d"),a&&(g=1!=a.scale.x?a.scale.x:a.zoomD,h=1!=a.scale.y?a.scale.y:a.zoomD,i=a.rotate.angle,j=a.moveXD,k=a.moveYD),console.log(i),d.generating=!1,document.querySelector("#generateBtn").innerHTML="生成海报",n=document.getElementById("result-canvas"),o=n.getContext("2d"),p=d.bgPos[d.curBg],q=$(".resultImg").get(d.curBg),b/q.naturalWidth,b/q.naturalWidth,c/q.naturalHeight,n.width=q.naturalWidth,n.height=q.naturalHeight,n.style.transform="scale("+b/q.naturalWidth+","+c/q.naturalHeight+")",n.style.transformOrigin="top left",a?(m.save(),m.translate(j,k),m.scale(g,h),m.rotate(i*Math.PI/180),m.drawImage(f,0,0,f.width,f.height),o.drawImage(l,0,0,l.width,l.height,p.x,p.y,p.width,p.height),m.restore()):o.drawImage(f,0,0,f.width,f.height,p.x,p.y,p.width,p.height),o.drawImage(q,0,0,q.naturalWidth,q.naturalHeight),o.font="40px Georgia",o.fillStyle="#fff",r=o.measureText(d.data.name).width,s=d.bgTxtPos.name.x+(d.bgTxtPos.name.width-r)/2,o.fillText(d.data.name,s,d.bgTxtPos.name.x,d.bgTxtPos.name.width),o.fillStyle="#daa956",o.font="40px Georgia",t=o.measureText(d.data.day).width,u=d.bgTxtPos.day.x+(d.bgTxtPos.day.width-t)/2,o.fillText(d.data.day,u,d.bgTxtPos.day.y,d.bgTxtPos.day.width),d.mySwiper.slideNext(),e=n.toDataURL("image/png",1),document.querySelector("#generateImg").src=e,d.postImg(e)},initZoom:function(b){var c=$("#people"),d=document.getElementsByClassName("backFace")[0];$(d).empty(),a=new Zoomage({container:d,enableGestureRotate:!0,dbclickZoomThreshold:.05,maxZoom:10,minZoom:.08,Orientation:e,onDrag:function(){c.addClass("mask")},onZoom:function(){c.addClass("mask")},onRotate:function(){c.addClass("mask")}}),a.load(b)},getAuth:function(){var a=this;navigator.userAgent.indexOf("MicroMessenger")>=0&&$.ajax({type:"POST",url:"http://gfwp.gac-toyota.com.cn/GTMCfamily/camp/2018birthday/do/?q=api/wechat/auth_check",data:{userinfo:1,redirect_uri:location.href},dataType:"json",success:function(b){0==b.data.is_auth?location.href=b.data.auth_url:a.getUserInfo()}}),this.record()},record:function(){$.ajax({type:"POST",url:"http://gfwp.gac-toyota.com.cn/GTMCfamily/camp/2018birthday/do/?q=api/visite/store",data:{},dataType:"json",success:function(a){console.log(a)}})},getUserInfo:function(){var a=this;$.ajax({type:"POST",url:"http://gfwp.gac-toyota.com.cn/GTMCfamily/camp/2018birthday/do/?q=api/user",data:{},dataType:"json",success:function(b){console.log(b),1===b.code?(a.data={name:b.data.gtmc_name,nickname:b.data.nickname,department:b.data.gtmc_department,headimgurl:b.data.headimgurl,day:b.data.entry_days.toLocaleString()},["name","department"].forEach(function(b){$("#"+b).text(a.data[b])}),$("#avatar").attr("src",b.data["headimgurl"])):alert(b.msg)}})},initSvg:function(){var g,i,j,h,k,l,m,n,o,p,q,r,s,t,u,a=document.getElementsByClassName("svg-p"),b=document.getElementsByClassName("svg-c"),d=document.getElementsByClassName("svg-main")[0],e=parseFloat((c/667).toFixed(2)),f=375*(95/108);for(d.style.width=f+"px",d.style.height=f+"px",d.style.transform="scale("+e+") translateX(-50%)",d.style.webkitTransformOrigin="scale("+e+") translateX(-50%)",g=f-90||300,h=[],k=45,l=45,m=1,n=g/2,o=g/2,p=g/2,q=p/m,s=[],i=0;m>i;i++){for(j=0;6>j;j++)t=Math.cos(60*j/180*Math.PI),u=-Math.sin(60*j/180*Math.PI),h.push(t*p+n+k+","+(u*p+o+l)),0==i&&(r=Math.min(.38,Math.abs(.38-Math.random()))*p+.6*p,s.push(t*r+n+k+","+(u*r+o+l)),b[j].setAttribute("cx",t*r+n+k),b[j].setAttribute("cy",u*r+o+l));p-=q,h=[]}a[0].setAttribute("points",s.join(" "))},initFace:function(){var a=document.getElementById("people"),d=a.getContext("2d"),e=parseInt(4*Math.random())+1,f=$(".bgImg").get(e-1);this.curBg=e-1,document.getElementById("people").src=f.src,$("#generateImg").attr("class","g"+e),a.width=f.naturalWidth,a.height=f.naturalHeight,a.style.transform="scale("+b/f.naturalWidth+","+c/f.naturalHeight+")",d.drawImage(f,0,0,f.naturalWidth,f.naturalHeight,0,0,f.naturalWidth,f.naturalHeight)},initSwiper:function(){this.mySwiper=new Swiper("#swiper-container",{freeMode:!1,allowTouchMove:!1,loop:!1,on:{init:function(){this.translate=0},slideChange:function(){3!=this.activeIndex?$(".p3").addClass("none"):$(".p3").removeClass("none"),4==this.activeIndex?$(".p4").removeClass("none"):$(".p4").addClass("none")},slideNextTransitionStart:function(){},slidePrevTransitionStart:function(){}}})},toast:function(a){window.__hint__||(window.__hint__=function(){function d(d){return c?(b.innerText=d,e(),void 0):(a.classList.add("in"),b.innerText=d,setTimeout(function(){a.classList.add("fade")},0),e(),void 0)}function e(){c&&clearTimeout(c),c=setTimeout(function(){a.classList.remove("fade","in"),c=void 0},1500)}var c,a=document.getElementById("hint"),b=a.querySelector(".h-content");return{show:d}}()),window.__hint__.show(a)},question:[{title:"部门会议开始，你会选择 坐在哪个位置?",data:["A.靠近领导的位置","B.靠近门口的位置","C.角落或者后排座位"]},{title:'<div class="question2">你偏好怎样的职场穿搭?</div>',data:["A.霸道总裁风OR时尚女王风","B.佛系穿搭，怎么舒服怎么来","C.公司服装很好看，我喜欢"]},{title:"职场上升，<br> 你的追求是什么？",data:["A.打怪升级，快速进阶","B.耐心打磨，稳步提升","C.特立独行，与世无争"]},{title:"赢得比赛，<br> 你觉得最重要的是什么？",data:["A.队友的配合，团战可靠","B.优秀的主力","C.优秀的辅助"]}],postImg:function(a){$.ajax({type:"POST",url:"http://gfwp.gac-toyota.com.cn/GTMCfamily/camp/2018birthday/do/?q=api/work/store",data:{base64:a},dataType:"json",success:function(a){console.log(a)}})},requestQuestion:function(a,b){$.ajax({type:"POST",url:"http://gfwp.gac-toyota.com.cn/GTMCfamily/camp/2018birthday/do/?q=api/answer/store",data:{question_id:a,answer:["A","B","C"][b]},dataType:"json",success:function(a){console.log(a)}})},initQuestion:function(){var a=$(".question"),b=$(".question-cnt"),c=!1,d=this.curQuestion,e=this.question[d],f=this;return a.find("li").each(function(a,b){return c=$(b).find("input").get(0).checked,c?(f.requestQuestion(d,a),!1):void 0}),c||0==d?e?(b.find(".question-index").html("Q"+(d+1)+"."),b.find(".question-title").html(e.title),a.find("li").each(function(a,b){$(b).find("label").html(e.data[a]),$(b).find("input").get(0).checked=!1}),this.curQuestion++,4==this.curQuestion&&$(".question-next").html("查看结果"),void 0):(this.curQuestion>=4&&this.mySwiper.slideNext(),void 0):(this.toast("请选择"),void 0)}};f.init()});