!function(a,b,c){if("undefined"==typeof c)throw"[Zoomage.js Error] You must use Zoomage.js in a browser environment, missing key object [document].";"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):global.Zoomage=b()}(this,function(){var a=function(a){if(!a||!a.container)throw"[Zoomage.js Error] Zoomage constructor: missing arguments [container].";this.container=a.container,this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas),this.context=this.canvas.getContext("2d"),this.onZoom=a.onZoom||null,this.onRotate=a.onRotate||null,this.onDrag=a.onDrag||null,this.context.save(),this.dbclickZoomThreshold=Math.abs(a.dbclickZoomThreshold)||.1,this.maxZoom=Math.abs(a.maxZoom)||2,this.minZoom=Math.abs(a.minZoom)||.2,this.enableGestureRotate=a.enableGestureRotate||!1,this.enableDesktop=a.enableDesktop||!1,this.imgTexture=new Image,this.isImgLoaded=!1,this.isFirstTimeLoad=!0,this.lastZoomScale=null,this.lastX=null,this.lastY=null,this.zoomD=1,this.mdown=!1,this.lastTouchEndTimestamp=null,this.lastTouchEndObject=null,this.animateHandle=null,this.dbclickZoomToggle=!0,this._checkRequestAnimationFrame(),this.enableGestureRotate?("transform"in document.body.style?this.prefixedTransform="transform":"webkitTransform"in document.body.style&&(this.prefixedTransform="webkitTransform"),this._setEventListeners_Transform(),requestAnimationFrame(this._animate_Transform.bind(this))):(this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this._setEventListeners_Canvas(),requestAnimationFrame(this._animate_Canvas.bind(this)))};return a.prototype={_animate_Transform:function(){this.zoomD>this.maxZoom?this.zoomD=this.maxZoom:this.zoomD<this.minZoom&&(this.zoomD=this.minZoom),this.isImgLoaded&&(this.canvas.style[this.prefixedTransform]="translate("+this.moveXD+"px,"+this.moveYD+"px) translateZ(0) scale("+this.zoomD+") rotate("+this.rotate.angle+"deg)"),this.isFirstTimeLoad&&this.isImgLoaded&&(this.context.drawImage(this.imgTexture,this.position.x,this.position.y,this.scale.x*this.imgTexture.width,this.scale.y*this.imgTexture.height),this.isFirstTimeLoad=!1),requestAnimationFrame(this._animate_Transform.bind(this))},_animate_Canvas:function(){null!==this.imgTexture.src&&(this.isOnTouching||this.mdown?this.context.clearRect(0,0,this.canvas.width,this.canvas.height):(this.context.restore(),this.context.save()),(this.isOnTouching||this.isFirstTimeLoad||this.mdown)&&this.isImgLoaded&&(this.context.drawImage(this.imgTexture,this.position.x,this.position.y,this.scale.x*this.imgTexture.width,this.scale.y*this.imgTexture.height),this.isFirstTimeLoad=!1),requestAnimationFrame(this._animate_Canvas.bind(this)))},_gesturePinchZoom:function(a){var c,d,e,b=!1;return a.length>=2&&(c=a[0],d=a[1],e=Math.sqrt(Math.pow(d.pageX-c.pageX,2)+Math.pow(d.pageY-c.pageY,2)),this.lastZoomScale&&(b=e-this.lastZoomScale),this.lastZoomScale=e),b},_enableGestureRotate:function(a){var c,d,e,f,g,b=!1;return a.length>=2&&(c=a[0],d=a[1],e=d.pageX-c.pageX,f=d.pageY-c.pageY,g=180*Math.atan2(2*f,e)/Math.PI),b={o:c,a:g}},_doZoom:function(a){var b,c,d,e,f,g;if(a)return b=this.scale.x,newScale=this.scale.x+a,c=newScale-b,d=this.imgTexture.width*c,e=this.imgTexture.height*c,f=this.position.x-d/2,g=this.position.y-e/2,newScale>this.maxZoom||newScale<this.minZoom?!1:(this.scale.x=newScale,this.scale.y=newScale,this.position.x=f,this.position.y=g,this.isOnTouching=!0,this.zoomD=newScale,this._runCallback("onZoom"),!0)},_doMove:function(a,b){if(this.lastX&&this.lastY){var c=a-this.lastX,d=b-this.lastY;this.imgTexture.width*this.scale.x,this.imgTexture.height*this.scale.y,this.position.x+=c,this.position.y+=d}this.lastX=a,this.lastY=b},_doRotate:function(a){null!==this.lastTouchRotateAngle&&(this.rotate.angle=this.rotate.angle+1.5*(a.a-this.lastTouchRotateAngle),this.rotate.center=a.o),this.lastTouchRotateAngle=a.a,this._runCallback("onRotate")},_zoomInAnim_Canvas:function(){var a=2*(this.dbclickZoomLength/10);if(this.dbclickZoomLength>.01){if(!this._doZoom(a))return!1;this.dbclickZoomLength=this.dbclickZoomLength-a,this.animateHandle=requestAnimationFrame(this._zoomInAnim_Canvas.bind(this))}else cancelAnimationFrame(this.animateHandle);return!0},_zoomOutAnim_Canvas:function(){var a=2*(this.dbclickZoomLength/10);if(this.dbclickZoomLength>.01){if(!this._doZoom(-a))return!1;this.dbclickZoomLength=this.dbclickZoomLength-a,this.animateHandle=requestAnimationFrame(this._zoomOutAnim_Canvas.bind(this))}else cancelAnimationFrame(this.animateHandle);return!0},_zoomInAnim_Transform:function(){var a=2*(this.dbclickZoomLength/10);return this.dbclickZoomLength>.01?(this.zoomD+=a,this.dbclickZoomLength=this.dbclickZoomLength-a,this.animateHandle=requestAnimationFrame(this._zoomInAnim_Transform.bind(this))):cancelAnimationFrame(this.animateHandle),!0},_zoomOutAnim_Transform:function(){var a=2*(this.dbclickZoomLength/10);return this.dbclickZoomLength>.01?(this.zoomD-=a,this.dbclickZoomLength=this.dbclickZoomLength-a,this.animateHandle=requestAnimationFrame(this._zoomOutAnim_Transform.bind(this))):cancelAnimationFrame(this.animateHandle),!0},_gestureDbClick:function(a,b){var d,c=a.changedTouches[0];null===this.lastTouchEndTimestamp||null===this.lastTouchEndObject?(this.lastTouchEndTimestamp=Math.round((new Date).getTime()),this.lastTouchEndObject=c):(d=Math.round((new Date).getTime()),d-this.lastTouchEndTimestamp<300&&Math.abs(this.lastTouchEndObject.pageX-c.pageX)<20&&Math.abs(this.lastTouchEndObject.pageY-c.pageY<20)&&b&&b(),this.lastTouchEndTimestamp=d,this.lastTouchEndObject=c)},rotateImg:function(a,b,c){var f,g,h,i,j,d=0,e=3;if(null!=a)switch(f=a.height,g=a.width,h=2,null==h&&(h=d),"right"==b?(h++,h>e&&(h=d)):(h--,d>h&&(h=e)),i=90*h*Math.PI/180,j=c.getContext("2d"),h){case 0:c.width=g,c.height=f,j.drawImage(a,0,0);break;case 1:c.width=f,c.height=g,j.rotate(i),j.drawImage(a,0,-f);break;case 2:c.width=g,c.height=f,j.rotate(i),j.drawImage(a,-g,-f);break;case 3:c.width=f,c.height=g,j.rotate(i),j.drawImage(a,-g,0)}},_runCallback:function(a){switch(a){case"onDrag":"function"===this._type(this.onDrag)&&this.onDrag.call(this,{x:this.lastX.toFixed(3),y:this.lastY.toFixed(3)});break;case"onRotate":"function"===this._type(this.onRotate)&&this.onRotate.call(this,{rotate:(this.rotate.angle%360).toFixed(3)});break;case"onZoom":"function"===this._type(this.onZoom)&&this.onZoom.call(this,{zoom:this.zoomD.toFixed(3),scale:{width:(this.zoomD*this.imgTexture.width).toFixed(3),height:(this.zoomD*this.imgTexture.height).toFixed(3)}})}},_setEventListeners_Transform:function(){this.container.addEventListener("touchend",function(a){this.lastZoomScale=null,this.lastTouchRotateAngle=null,this.enableDesktop||this._gestureDbClick(a,function(){this.dbclickZoomLength=this.dbclickZoomThreshold,this.dbclickZoomToggle?this._zoomInAnim_Transform()||this._zoomOutAnim_Transform():this._zoomOutAnim_Transform()||this._zoomInAnim_Transform(),this.dbclickZoomToggle=!this.dbclickZoomToggle}.bind(this))}.bind(this)),this.container.addEventListener("touchstart",function(){this.lastX=null,this.lastY=null}.bind(this)),this.container.addEventListener("touchmove",function(a){a.preventDefault(),2==a.touches.length?(this.zoomD=this.zoomD+this._gesturePinchZoom(a.touches)/2e3,this._runCallback("onZoom"),this._doRotate(this._enableGestureRotate(a.touches))):1==a.touches.length&&(null!==this.lastX&&null!==this.lastY&&(this.moveXD+=(a.touches[0].pageX-this.lastX)/2,this.moveYD+=(a.touches[0].pageY-this.lastY)/2),this.lastX=a.touches[0].pageX,this.lastY=a.touches[0].pageY,this._runCallback("onDrag"))}.bind(this)),this.imgTexture.addEventListener("load",function(){var b,c=this;this.moveXD=0,this.moveYD=0,this.zoomD=1,this.lastTouchRotateAngle=null,this.rotate={center:{},angle:0},this.canvas.width=this.imgTexture.width,this.canvas.height=this.imgTexture.height,this.canvas.setAttribute("width",this.imgTexture.width+"px"),this.canvas.setAttribute("height",this.imgTexture.height+"px"),this.imgTexture.width>this.imgTexture.height?this.canvas.parentNode.clientWidth<this.imgTexture.width?(this.zoomD=this.canvas.parentNode.clientWidth/this.imgTexture.width,this.moveYD=(this.canvas.parentNode.clientHeight-this.zoomD*this.imgTexture.height)/2-this.imgTexture.height*(1-this.zoomD)/2,this.moveXD=-this.imgTexture.width*(1-this.zoomD)/2):(this.moveXD=(this.canvas.parentNode.clientWidth-this.imgTexture.width)/2,this.moveYD=(this.canvas.parentNode.clientHeight-this.imgTexture.height)/2):this.canvas.parentNode.clientWidth<this.imgTexture.width?(this.zoomD=this.canvas.parentNode.clientHeight/this.imgTexture.height,this.moveXD=(this.canvas.parentNode.clientWidth-this.zoomD*this.imgTexture.width)/2-this.imgTexture.width*(1-this.zoomD)/2,this.moveYD=-this.imgTexture.height*(1-this.zoomD)/2):(this.moveXD=(this.canvas.parentNode.clientWidth-this.imgTexture.width)/2,this.moveYD=(this.canvas.parentNode.clientHeight-this.imgTexture.height)/2),this.isImgLoaded=!0,EXIF.getData(this.imgTexture,function(){var e,f,g,h,a=c.imgTexture.naturalWidth,d=c.imgTexture.naturalHeight;if(console.log(EXIF.getAllTags(this)),b=EXIF.getTag(this,"Orientation"),console.log("Orientation",b),console.log("width:"+a+";height:"+d),(a>4e3||d>4e3)&&(c.minZoom=.04,console.log("minZoom:"+c.minZoom)),console.log("width:"+a+";height:"+d),navigator.userAgent.match(/iphone/gi)&&b&&1!=b&&(e=a,f=d,a>d&&a>800?(e=800,f=e*d/a):d>a&&d>1200&&(f=1200,e=f*a/d),g=c.canvas,h=c.context,g.width=e,g.height=f,h.drawImage(c.imgTexture,0,0,e,f),b&&1!=b))switch(b){case 6:c.rotateImg(c.imgTexture,"left",g);break;case 8:c.rotateImg(c.imgTexture,"right",g);break;case 3:c.rotateImg(c.imgTexture,"right",g),c.rotateImg(c.imgTexture,"right",g)}c.moveXD=0,c.rotate.angle=0,c.moveYD=.4*Math.abs(document.body.offsetHeight-c.canvas.height*c.zoomD),console.log("moveYD:"+c.moveYD),console.log("zoomD:"+c.zoomD),c._animate_Transform()})}.bind(this)),this.enableDesktop&&(window.addEventListener("keyup",function(a){187==a.keyCode?this.zoomD+=.1:189==a.keyCode&&(this.zoomD-=.1),(187==a.keyCode||189==a.keyCode)&&this._runCallback("onZoom")}.bind(this)),window.addEventListener("mousedown",function(){this.mdown=!0,this.lastX=null,this.lastY=null}.bind(this)),window.addEventListener("mouseup",function(){this.mdown=!1}.bind(this)),window.addEventListener("mousemove",function(a){this.mdown&&(null!==this.lastX&&null!==this.lastY&&(this.moveXD+=a.pageX-this.lastX,this.moveYD+=a.pageY-this.lastY),this.lastX=a.pageX,this.lastY=a.pageY,this._runCallback("onDrag"))}.bind(this)),window.addEventListener("dblclick",function(){this.dbclickZoomLength=this.dbclickZoomThreshold,this.dbclickZoomToggle?this._zoomInAnim_Transform()||this._zoomOutAnim_Transform():this._zoomOutAnim_Transform()||this._zoomInAnim_Transform(),this.dbclickZoomToggle=!this.dbclickZoomToggle}.bind(this)))},_setEventListeners_Canvas:function(){this.canvas.addEventListener("touchend",function(a){this.isOnTouching=!1,this.lastZoomScale=null,this.enableDesktop||this._gestureDbClick(a,function(){this.dbclickZoomLength=this.dbclickZoomThreshold,this.dbclickZoomToggle?this._zoomInAnim_Canvas()||this._zoomOutAnim_Canvas():this._zoomOutAnim_Canvas()||this._zoomInAnim_Canvas(),this.dbclickZoomToggle=!this.dbclickZoomToggle}.bind(this))}.bind(this)),this.canvas.addEventListener("touchstart",function(){this.isOnTouching=!0,this.lastX=null,this.lastY=null}.bind(this)),this.canvas.addEventListener("touchmove",function(a){if(a.preventDefault(),2==a.targetTouches.length)this._doZoom(this._gesturePinchZoom(a.targetTouches)/100);else if(1==a.targetTouches.length){var b=a.targetTouches[0].pageX-this.canvas.getBoundingClientRect().left,c=a.targetTouches[0].pageY-this.canvas.getBoundingClientRect().top;this._doMove(b,c),this._runCallback("onDrag")}}.bind(this)),this.imgTexture.addEventListener("load",function(){if(this.isOnTouching=!1,this.lastTouchEndTimestamp=null,this.lastTouchEndObject=null,this.dbclickZoomLength=0,this.imgTexture.width&&this.imgTexture.height){var b=1;this.imgTexture.width>this.imgTexture.height?this.canvas.clientWidth<this.imgTexture.width?(b=this.canvas.clientWidth/this.imgTexture.width,this.position.y=(this.canvas.clientHeight-b*this.imgTexture.height)/2):(this.position.x=(this.canvas.clientWidth-this.imgTexture.width)/2,this.position.y=(this.canvas.clientHeight-this.imgTexture.height)/2):this.canvas.clientWidth<this.imgTexture.width?(b=this.canvas.clientHeight/this.imgTexture.height,this.position.x=(this.canvas.clientWidth-b*this.imgTexture.width)/2):(this.position.x=(this.canvas.clientWidth-this.imgTexture.width)/2,this.position.y=(this.canvas.clientHeight-this.imgTexture.height)/2),this.scale.x=b,this.scale.y=b}this.isImgLoaded=!0}.bind(this)),this.enableDesktop&&(window.addEventListener("keyup",function(a){187==a.keyCode?this._doZoom(.05):189==a.keyCode&&this._doZoom(-.05)}.bind(this)),window.addEventListener("mousedown",function(){this.mdown=!0,this.lastX=null,this.lastY=null}.bind(this)),window.addEventListener("mouseup",function(){this.mdown=!1}.bind(this)),window.addEventListener("mousemove",function(a){var b=a.pageX-this.canvas.getBoundingClientRect().left,c=a.pageY-this.canvas.getBoundingClientRect().top;a.target==this.canvas&&this.mdown&&this._doMove(b,c),(0>=b||b>=this.canvas.clientWidth||0>=c||c>=this.canvas.clientHeight)&&(this.mdown=!1),this._runCallback("onDrag")}.bind(this)),window.addEventListener("dblclick",function(){this.dbclickZoomLength=this.dbclickZoomThreshold,this.dbclickZoomToggle?this._zoomInAnim_Canvas()||this._zoomOutAnim_Canvas():this._zoomOutAnim_Canvas()||this._zoomInAnim_Canvas(),this.dbclickZoomToggle=!this.dbclickZoomToggle}.bind(this)))},_type:function(a){var b={},c=b.toString;return b["[object Function]"]="function",null==a?a+"":"object"==typeof a||"function"==typeof a?b[c.call(a)]||"object":typeof a},_checkRequestAnimationFrame:function(){var c,a=0,b=["ms","moz","webkit","o"];for(c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})},zoom:function(a){this.dbclickZoomLength=Math.abs(a),this.enableGestureRotate?a>0?this._zoomInAnim_Transform():this._zoomOutAnim_Transform():a>0?this._zoomInAnim_Canvas():this._zoomOutAnim_Canvas()},load:function(a){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.position={x:0,y:0},this.scale={x:1,y:1},this.isImgLoaded=!1,this.isFirstTimeLoad=!0,this.lastZoomScale=null,this.lastX=null,this.lastY=null,this.mdown=!1,this.lastTouchEndTimestamp=null,this.lastTouchEndObject=null,this.imgTexture.src=a}},a},window.document);